<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Controle de Ponto • Alpha (v5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","system-ui","-apple-system","Segoe UI","Roboto","Ubuntu","Cantarell","Noto Sans","Helvetica Neue","Arial","sans-serif"] },
          boxShadow: { glow: "0 10px 25px -5px rgba(59,130,246,.25), 0 8px 10px -6px rgba(59,130,246,.3)" }
        }
      }
    }
  </script>
  <style>
    :root{ --safe-top: env(safe-area-inset-top,0px); --safe-bottom: env(safe-area-inset-bottom,0px) }
    @keyframes pulseDot{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.25);opacity:.65}}
    .animate-dot{animation:pulseDot 1.2s ease-in-out infinite}
    /* Modal animation */
    #modalFoto.opacity-0 { pointer-events: none; }
    #modalFoto .modal-content { transition: transform .25s ease, opacity .15s ease; }
    #modalFoto.opacity-0 .modal-content { transform: translateY(8px) scale(.98); opacity: .0 }
    .tela{ display:none }
    .tela.ativa{ display:block }
  </style>
</head>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter","system-ui","-apple-system","Segoe UI","Roboto","Ubuntu","Cantarell","Noto Sans","Helvetica Neue","Arial","sans-serif"] },
          boxShadow: { glow: "0 10px 25px -5px rgba(59,130,246,.25), 0 8px 10px -6px rgba(59,130,246,.3)" }
        }
      }
    }
  </script>
  <style>
    :root{ --safe-top: env(safe-area-inset-top,0px); --safe-bottom: env(safe-area-inset-bottom,0px) }
    @keyframes pulseDot{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.25);opacity:.65}}
    .animate-dot{animation:pulseDot 1.2s ease-in-out infinite}
    /* Modal animation */
    #modalFoto.opacity-0 { pointer-events: none; }
    #modalFoto .modal-content { transition: transform .25s ease; }
    #modalFoto.opacity-0 .modal-content { transform: translateY(8px) scale(.98); }
    .tela{ display:none }
    .tela.ativa{ display:block }
  </style>
</head>
<body class="bg-slate-50 min-h-[100svh] font-sans pb-[var(--safe-bottom)]">
  <!-- HEADER -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-xl mx-auto px-3 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="h-9 w-9 rounded-2xl bg-blue-600 grid place-items-center shadow-glow flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#fff" class="h-5 w-5"><path d="M12 1.5a.75.75 0 0 1 .75.75v3.28a6.75 6.75 0 1 1-1.5 0V2.25A.75.75 0 0 1 12 1.5Zm0 7.5a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5A.75.75 0 0 1 12 9Z"/></svg>
        </div>
        <div class="truncate">
          <h1 class="text-base font-bold leading-tight truncate">Controle de Ponto</h1>
          <p class="text-[11px] text-slate-600 truncate">Foto + geolocalização + justificativas</p>
        </div>
      </div>
      <div class="text-right">
        <div class="text-[10px] uppercase tracking-wide text-slate-500">Agora</div>
        <div id="clock" class="text-sm font-semibold">--:--:--</div>
      </div>
    </div>
  </header>

  <!-- APP CONTAINER (telas) -->
  <main id="app-container" class="max-w-xl mx-auto px-3 py-4">

    <!-- 1) Tela inicial -->
    <section id="tela-inicial" class="tela ativa bg-white p-6 rounded-2xl shadow-xl text-center">
      <h2 class="text-2xl md:text-3xl font-bold text-blue-700 mb-6">O que deseja fazer?</h2>
      <div class="flex flex-col gap-4">
        <button id="btn-ir-ponto" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-glow active:scale-[0.99]">Registrar Ponto</button>
        <button id="btn-ir-ausencia" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-4 rounded-xl font-bold text-lg shadow-xl active:scale-[0.99]">Justificar Ausência</button>
      </div>
      <div id="httpsWarn" class="mt-4 text-[11px] text-slate-500 flex items-center justify-center gap-2"><span class="h-2 w-2 bg-emerald-500 rounded-full animate-dot"></span>Conexão segura</div>
    </section>

    <!-- 2) Tela de ponto -->
    <section id="tela-ponto" class="tela bg-white p-6 rounded-2xl shadow-xl">
      <button class="voltar-btn text-blue-600 font-semibold mb-2">&larr; Voltar</button>
      <h2 class="text-2xl font-bold text-blue-700 mb-4">Registrar Ponto</h2>

      <div class="mb-4">
        <label for="nomeSelectPonto" class="block mb-2 font-medium">Funcionário</label>
        <select id="nomeSelectPonto" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-100 text-[16px]">
          <option value="">-- Selecione seu nome --</option>
          <option value="Adrian Lima">Adrian Lima</option>
          <option value="Miriã França">Miriã França</option>
          <option value="Livia Guedes">Livia Guedes</option>
          <option value="Quitéria">Quitéria</option>
        </select>
      </div>

      <div class="mb-4">
        <span class="block mb-2 font-medium">Tipo de registro</span>
        <fieldset id="tipoFieldsetPonto" class="grid grid-cols-1 gap-2">
          <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistroPonto" value="Entrada"><span>Entrada</span></label>
          <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistroPonto" value="Saída Almoço"><span>Saída Almoço</span></label>
          <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistroPonto" value="Entrada Almoço"><span>Entrada Almoço</span></label>
          <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistroPonto" value="Saída"><span>Saída</span></label>
        </fieldset>
      </div>

      <button id="abrirModalPontoBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg shadow-glow active:scale-[0.99]">Continuar (Foto)</button>
      <div id="erroPonto" class="text-rose-600 font-semibold mt-3 min-h-6"></div>
    </section>

    <!-- 3) Tela de ausência -->
    <section id="tela-ausencia" class="tela bg-white p-6 rounded-2xl shadow-xl">
      <button class="voltar-btn text-blue-600 font-semibold mb-2">&larr; Voltar</button>
      <h2 class="text-2xl font-bold text-slate-800 mb-4">Justificar Ausência</h2>

      <div class="mb-4">
        <label for="nomeSelectAusencia" class="block mb-2 font-medium">Funcionário</label>
        <select id="nomeSelectAusencia" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-100 text-[16px]">
          <option value="">-- Selecione seu nome --</option>
          <option value="Adrian Lima">Adrian Lima</option>
          <option value="Miriã França">Miriã França</option>
          <option value="Livia Guedes">Livia Guedes</option>
          <option value="Quitéria">Quitéria</option>
        </select>
      </div>

      <div class="mb-4">
        <span class="block mb-2 font-medium">Tipo de ausência</span>
        <fieldset id="tipoFieldsetAusencia" class="grid grid-cols-1 gap-2">
          <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistroAusencia" value="Atestado Médico"><span>Atestado Médico</span></label>
          <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistroAusencia" value="Comprovante de Horas"><span>Comprovante de Horas</span></label>
          <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistroAusencia" value="Outro"><span>Outro</span></label>
        </fieldset>
      </div>

      <div class="mb-4">
        <label for="justificativaText" class="block mb-2 font-medium">Justificativa (obrigatório)</label>
        <textarea id="justificativaText" rows="3" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-100 text-[16px]" placeholder="Descreva brevemente o motivo..."></textarea>
      </div>

      <button id="abrirModalAusenciaBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-xl font-bold text-lg shadow-xl active:scale-[0.99]">Anexar Comprovante (Foto)</button>
      <div id="erroAusencia" class="text-rose-600 font-semibold mt-3 min-h-6"></div>
    </section>

  </main>

  <!-- MODAL (bottom sheet / responsivo) -->
  <div id="modalFoto" class="fixed inset-0 bg-black/70 flex items-end md:items-center justify-center z-50 p-3 transition-opacity duration-200 opacity-0">
    <div class="modal-content bg-white w-full max-w-xl md:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h3 id="modalTitulo" class="text-lg md:text-xl font-bold">—</h3>
        <button id="fecharModal" class="p-2 rounded-lg hover:bg-slate-100" aria-label="Fechar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5"><path d="M6.225 4.811a.75.75 0 0 1 1.06 0L12 9.525l4.715-4.714a.75.75 0 1 1 1.06 1.06L13.06 10.586l4.715 4.715a.75.75 0 1 1-1.06 1.06L12 11.646l-4.715 4.715a.75.75 0 0 1-1.06-1.06l4.714-4.715-4.714-4.714a.75.75 0 0 1 0-1.061Z"/></svg>
        </button>
      </div>

      <div class="p-4">
        <div class="relative rounded-xl overflow-hidden border bg-slate-100">
          <video id="video" autoplay playsinline class="w-full aspect-[3/4] object-cover bg-slate-200">Vídeo não disponível.</video>
          <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
            <div class="h-40 w-40 md:h-48 md:w-48 rounded-full border-4 border-white/70 shadow-[0_0_0_100vmax_rgba(0,0,0,0.25)]"></div>
          </div>
        </div>
        <canvas id="canvas" class="hidden"></canvas>

        <button id="confirmarRegistroBtn" class="mt-4 w-full text-white py-3 rounded-xl font-bold text-lg shadow-xl">Confirmar</button>
        <div id="mensagem" class="mt-3 text-sm min-h-6 text-center"></div>
      </div>
    </div>
  </div>

  <!-- OVERLAY DE STATUS (novo) -->
  <div id="statusOverlay" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/70 p-6">
    <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 text-center">
      <div id="statusIcon" class="mx-auto mb-3 h-12 w-12 rounded-full grid place-items-center bg-slate-100"></div>
      <h4 id="statusTitle" class="text-lg font-bold">Processando…</h4>
      <p id="statusText" class="text-sm text-slate-600 mt-1">Estamos registrando seu envio. Aguarde…</p>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-2xl"></div>

  <script>
    // ===== CONFIG =====
    const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbyHeYRDwUzulSPUQ3nwh2kp9b_euSbK2jJxb09IGCQcyGb-JbCTG7Q6Z72nDdbJP_j2TA/exec";

    // ===== UTILS =====
    const $ = (s) => document.querySelector(s);
    const toast = $('#toast');
    const showToast = (msg, ms=2200) => { toast.textContent = msg; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), ms); };
    const isHttpsOk = () => location.protocol === 'https:' || location.hostname === 'localhost';
    (function startClock(){ const el=document.getElementById('clock'); const t=()=> el.textContent=new Date().toLocaleTimeString('pt-BR'); t(); setInterval(t,1000) })();

    // Overlay helpers
    const overlay = $('#statusOverlay');
    const statusIcon = $('#statusIcon');
    const statusTitle = $('#statusTitle');
    const statusText = $('#statusText');
    function showOverlayLoading(title='Registrando…', text='Estamos processando seu envio. Aguarde…'){
      overlay.classList.remove('hidden');
      statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 animate-spin"><path fill="currentColor" d="M12 2a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1Zm0 16a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1ZM4.93 4.93a1 1 0 0 1 1.41 0l1.42 1.41a1 1 0 1 1-1.42 1.42L4.93 6.34a1 1 0 0 1 0-1.41ZM16.24 16.24a1 1 0 0 1 1.42 0l1.41 1.42a1 1 0 0 1-1.41 1.41l-1.42-1.41a1 1 0 0 1 0-1.42ZM2 12a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2H3a1 1 0 0 1-1-1Zm16 0a1 1 0 0 1 1-1h2a1 1 0 1 1 0 2h-2a1 1 0 0 1-1-1ZM4.93 19.07a1 1 0 0 1 1.41 0l1.42-1.41a1 1 0 0 1 1.42 1.41l-1.42 1.41a1 1 0 0 1-1.41 0ZM16.24 7.76a1 1 0 0 1 1.42 0l1.41-1.42a1 1 0 1 1 1.41 1.42L17.66 9.17a1 1 0 0 1-1.42-1.41Z"/></svg>';
      statusTitle.textContent = title; statusText.textContent = text;
    }
    function showOverlaySuccess(title='Registro realizado com sucesso!', text='Tudo certo. Você será redirecionado.'){
      overlay.classList.remove('hidden');
      statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-emerald-600"><path fill="currentColor" d="M10.97 16.28a.75.75 0 0 1-1.06 0l-3.22-3.22a.75.75 0 1 1 1.06-1.06l2.69 2.69 6.41-6.41a.75.75 0 1 1 1.06 1.06l-6.94 6.94Z"/></svg>';
      statusTitle.textContent = title; statusText.textContent = text;
    }
    function showOverlayError(title='Erro ao enviar', text='Tente novamente em instantes.'){
      overlay.classList.remove('hidden');
      statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6 text-rose-600"><path fill="currentColor" d="M12 2a10 10 0 1 1 0 20A10 10 0 0 1 12 2Zm0 11.5a1 1 0 1 0 0 2 1 1 0 0 0 0-2Zm1-6.5h-2v6h2V7Z"/></svg>';
      statusTitle.textContent = title; statusText.textContent = text;
    }
    function hideOverlay(){ overlay.classList.add('hidden'); }

    // ===== ELEMENTOS =====
    const telaInicial = $('#tela-inicial');
    const telaPonto = $('#tela-ponto');
    const telaAusencia = $('#tela-ausencia');

    $('#btn-ir-ponto').addEventListener('click', ()=>mudarTela('ponto'));
    $('#btn-ir-ausencia').addEventListener('click', ()=>mudarTela('ausencia'));
    document.querySelectorAll('.voltar-btn').forEach(btn=> btn.addEventListener('click', ()=>mudarTela('inicial')));

    const nomeSelectPonto = $('#nomeSelectPonto');
    const erroPonto = $('#erroPonto');
    const nomeSelectAusencia = $('#nomeSelectAusencia');
    const justificativaText = $('#justificativaText');
    const erroAusencia = $('#erroAusencia');

    const modal = $('#modalFoto');
    const video = $('#video');
    const canvas = $('#canvas');
    const confirmarRegistroBtn = $('#confirmarRegistroBtn');
    const mensagemDiv = $('#mensagem');
    const modalTitulo = $('#modalTitulo');

    const httpsWarn = document.getElementById('httpsWarn');
    if(!isHttpsOk()) { httpsWarn.textContent='Ative HTTPS para usar a câmera no celular'; httpsWarn.classList.add('text-rose-600'); }

    let currentAction = null; // 'ponto' | 'ausencia'
    let streamAtivo = null;

    function mudarTela(t){
      [telaInicial,telaPonto,telaAusencia].forEach(n=>n.classList.remove('ativa'));
      if(t==='ponto') telaPonto.classList.add('ativa');
      else if(t==='ausencia') telaAusencia.classList.add('ativa');
      else telaInicial.classList.add('ativa');
    }

    // Botões de ação
    document.getElementById('abrirModalPontoBtn').addEventListener('click', abrirModalPonto);
    document.getElementById('abrirModalAusenciaBtn').addEventListener('click', abrirModalAusencia);

    function abrirModalPonto(){
      const tipoSelecionado = document.querySelector('input[name="tipoRegistroPonto"]:checked');
      if(!nomeSelectPonto.value || !tipoSelecionado){ erroPonto.textContent='Por favor, selecione nome e tipo.'; return }
      erroPonto.textContent=''; currentAction='ponto';
      modalTitulo.textContent='Tire sua foto para confirmar';
      prepararBotaoConfirmar('Confirmar Ponto','bg-emerald-600 hover:bg-emerald-700');
      iniciarCameraEModal('user');
    }

    function abrirModalAusencia(){
      const tipoAus = document.querySelector('input[name="tipoRegistroAusencia"]:checked');
      if(!nomeSelectAusencia.value || !tipoAus || !justificativaText.value.trim()){ erroAusencia.textContent='Preencha nome, tipo e justificativa.'; return }
      erroAusencia.textContent=''; currentAction='ausencia';
      modalTitulo.textContent='Foto do Atestado/Comprovante';
      prepararBotaoConfirmar('Enviar Justificativa','bg-blue-600 hover:bg-blue-700');
      iniciarCameraEModal('environment');
    }

    function prepararBotaoConfirmar(text, classes){
      confirmarRegistroBtn.textContent = text; 
      confirmarRegistroBtn.className = `mt-4 w-full text-white py-3 rounded-xl font-bold text-lg shadow-xl ${classes}`;
      mensagemDiv.textContent=''; mensagemDiv.className='mt-3 text-sm text-center';
      confirmarRegistroBtn.disabled=false;
    }

    async function iniciarCameraEModal(facing){
      modal.classList.remove('opacity-0');
      try{
        // Safari/iOS precisa do muted para autoplay
        video.muted = true; 
        video.setAttribute('playsinline','');
        streamAtivo = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing }, audio: false });
        video.srcObject = streamAtivo; await video.play().catch(()=>{});
      }catch(err){
        console.warn('Erro câmera preferida, tentando fallback:', err);
        try{ 
          streamAtivo = await navigator.mediaDevices.getUserMedia({ video: true, audio:false }); 
          video.srcObject = streamAtivo; await video.play().catch(()=>{}); 
        }
        catch(e){ 
          mensagemDiv.textContent='Erro ao acessar a câmera. Verifique permissões.'; 
          mensagemDiv.className='mt-3 text-sm text-rose-600 font-semibold'; 
        }
      }
    }

    function fecharModal(){ 
      modal.classList.add('opacity-0'); 
      if(streamAtivo){ streamAtivo.getTracks().forEach(t=>t.stop()); streamAtivo=null } 
    }

    // Esconde visualmente o modal mas mantém o stream ativo (para não “preto”) 
    function esconderModalVisual(){
      modal.classList.add('opacity-0');
    }

    // Garante que o vídeo tem dimensões válidas antes da captura
    async function ensureVideoReady(maxWaitMs=1500){
      const start = performance.now();
      while((video.videoWidth||0) < 2 || (video.videoHeight||0) < 2){
        await new Promise(r=>requestAnimationFrame(r));
        if(performance.now()-start > maxWaitMs) break;
      }
    }

    function blobToDataURL(blob){
      return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); });
    }

    async function capturarFoto(){
      // Tenta ImageCapture primeiro (melhor em alguns Androids)
      try{
        if(streamAtivo && 'ImageCapture' in window){
          const track = streamAtivo.getVideoTracks()[0];
          if(track){
            const ic = new ImageCapture(track);
            const blob = await ic.takePhoto();
            return await blobToDataURL(blob);
          }
        }
      }catch(_){ /* fallback para canvas abaixo */ }

      await ensureVideoReady();
      const vw = video.videoWidth || 720, vh = video.videoHeight || 960;
      canvas.width = vw; canvas.height = vh;
      const ctx = canvas.getContext('2d', { willReadFrequently: true }); if(!ctx) throw new Error('Canvas não suportado');
      ctx.drawImage(video,0,0,vw,vh);
      return canvas.toDataURL('image/jpeg',0.92);
    }

    }

    function fecharModal(){ modal.classList.add('opacity-0'); if(streamAtivo){ streamAtivo.getTracks().forEach(t=>t.stop()); streamAtivo=null } }

    async function capturarFoto(){
      const vw = video.videoWidth || 720, vh = video.videoHeight || 960;
      canvas.width = vw; canvas.height = vh;
      const ctx = canvas.getContext('2d'); if(!ctx) throw new Error('Canvas não suportado');
      ctx.drawImage(video,0,0,vw,vh);
      return canvas.toDataURL('image/jpeg',0.9);
    }

    async function enviarRegistro(){
      // Mostra overlay imediatamente (UX), mas NÃO mata a câmera ainda
      showOverlayLoading('Registrando…','Estamos processando seu envio. Aguarde…');

      // Evita toques repetidos
      confirmarRegistroBtn.disabled=true;

      let fotoBase64='';
      try{ 
        // Esconde o modal visualmente para o usuário sem parar o stream
        esconderModalVisual();
        fotoBase64 = await capturarFoto(); 
      }
      catch(e){ 
        showOverlayError('Falha ao capturar a foto','Verifique a câmera e tente novamente.'); 
        setTimeout(()=>hideOverlay(), 1800); 
        return; 
      }

      let payload={}, successMessage='';
      if(currentAction==='ponto'){
        const nome = nomeSelectPonto.value; const tipo = (document.querySelector('input[name="tipoRegistroPonto"]:checked')||{}).value;
        let latitude='N/A', longitude='N/A';
        try{ const pos = await getGeolocation({timeout:10000, enableHighAccuracy:true}); latitude=pos.coords.latitude; longitude=pos.coords.longitude; }
        catch(err){ latitude = (err && err.code===1)? 'Permissão negada':'Erro de localização'; longitude='N/A'; }
        payload = { action:'ponto', nome, fotoBase64, tipo, latitude, longitude };
        successMessage='Registro realizado com sucesso!';
      } else {
        const nome = nomeSelectAusencia.value; const tipoAusencia = (document.querySelector('input[name="tipoRegistroAusencia"]:checked')||{}).value; const justificativa = justificativaText.value;
        payload = { action:'ausencia', nome, fotoBase64, tipoAusencia, justificativa };
        successMessage='Enviado com sucesso! Seu atestado será analisado pelo RH.';
      }

      try{
        const resp = await fetch(URL_APPS_SCRIPT, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
        const resultado = await resp.json().catch(()=>({status:'erro',mensagem:'Resposta inválida'}));
        if(resultado.status!=='sucesso') throw new Error(resultado.mensagem||'Erro no servidor');
        showOverlaySuccess(successMessage, 'Você será redirecionado.');
        showToast('✅ Enviado');
      }catch(err){
        console.error(err);
        showOverlayError('Erro ao enviar', (err && err.message) ? err.message : 'Tente novamente em instantes.');
        setTimeout(()=> hideOverlay(), 2200);
        confirmarRegistroBtn.disabled=false;
        return;
      } finally {
        // Agora sim, pode desligar a câmera
        fecharModal();
      }

      setTimeout(()=>{ hideOverlay(); limparFormulario(); mudarTela('inicial'); }, 1400);
    }

    function limparFormulario(){
(){
      nomeSelectPonto.value=''; const r1=document.querySelector('input[name="tipoRegistroPonto"]:checked'); if(r1) r1.checked=false;
      nomeSelectAusencia.value=''; justificativaText.value=''; const r2=document.querySelector('input[name="tipoRegistroAusencia"]:checked'); if(r2) r2.checked=false;
    }

    function getGeolocation(options){
      return new Promise((resolve,reject)=>{ if(!('geolocation' in navigator)) return reject(new Error('Geolocalização não é suportada.')); navigator.geolocation.getCurrentPosition(resolve,reject,options); });
    }

    // Eventos modal
    document.getElementById('fecharModal').addEventListener('click', fecharModal);
    document.getElementById('modalFoto').addEventListener('click', (e)=>{ if(e.target.id==='modalFoto') fecharModal(); });
    confirmarRegistroBtn.addEventListener('click', enviarRegistro);
  </script>
</body>
</html>
