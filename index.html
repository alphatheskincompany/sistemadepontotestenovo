<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Registro de Ponto • Alpha (v2)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { fontFamily: { sans: ["Inter","system-ui","-apple-system","Segoe UI","Roboto","Ubuntu","Cantarell","Noto Sans","Helvetica Neue","Arial","sans-serif"] }, boxShadow: { glow: "0 10px 25px -5px rgba(59,130,246,.25), 0 8px 10px -6px rgba(59,130,246,.3)" } } }
    }
  </script>
  <style>
    :root{ --safe-top: env(safe-area-inset-top,0px); --safe-bottom: env(safe-area-inset-bottom,0px) }
    @keyframes pulseDot{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.25);opacity:.65}}
    .animate-dot{animation:pulseDot 1.2s ease-in-out infinite}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-blue-50 text-slate-800 font-sans pb-[var(--safe-bottom)]">
  <!-- HEADER -->
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-xl mx-auto px-3 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="h-9 w-9 rounded-2xl bg-blue-600 grid place-items-center shadow-glow flex-shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#fff" class="h-5 w-5"><path d="M12 1.5a.75.75 0 0 1 .75.75v3.28a6.75 6.75 0 1 1-1.5 0V2.25A.75.75 0 0 1 12 1.5Zm0 7.5a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5A.75.75 0 0 1 12 9Z"/></svg>
        </div>
        <div class="truncate">
          <h1 class="text-base font-bold leading-tight truncate">Registro de Ponto</h1>
          <p class="text-[11px] text-slate-600 truncate">Foto + geolocalização</p>
        </div>
      </div>
      <div class="text-right">
        <div class="text-[10px] uppercase tracking-wide text-slate-500">Agora</div>
        <div id="clock" class="text-sm font-semibold">--:--:--</div>
      </div>
    </div>
  </header>

  <!-- MAIN (mobile-first, uma coluna) -->
  <main class="max-w-xl mx-auto px-3 py-4 space-y-4">
    <section class="bg-white rounded-2xl shadow-xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold text-blue-700">Bater Ponto</h2>
        <span id="httpsWarn" class="flex items-center gap-2 text-[11px] text-slate-500">
          <span class="h-2 w-2 bg-emerald-500 rounded-full animate-dot"></span>
          Conexão segura
        </span>
      </div>

      <!-- Form -->
      <label class="block mb-2 font-medium" for="nomeSelect">Funcionário</label>
      <select id="nomeSelect" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-100 text-[16px] mb-3">
        <option value="">-- Selecione seu nome --</option>
        <option>Adrian Lima</option>
        <option>Miriã França</option>
        <option>Livia Guedes</option>
        <option>Quitéria</option>
      </select>

      <span class="block mb-2 font-medium">Tipo de registro</span>
      <div class="grid grid-cols-1 gap-2 mb-3" id="tipoFieldset">
        <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistro" value="Entrada"><span>Entrada</span></label>
        <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistro" value="Saída Almoço"><span>Saída Almoço</span></label>
        <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistro" value="Entrada Almoço"><span>Entrada Almoço</span></label>
        <label class="flex items-center gap-3 p-3 rounded-xl border border-slate-300"><input class="w-5 h-5 accent-blue-600" type="radio" name="tipoRegistro" value="Saída"><span>Saída</span></label>
      </div>

      <label class="block mb-2 font-medium" for="obs">Observação (opcional)</label>
      <input id="obs" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-4 focus:ring-blue-100 text-[16px] mb-2" placeholder="Ex.: visita externa" />

      <button id="abrirModalBtn" class="w-full inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-4 rounded-xl shadow-glow transition active:scale-[0.99]">Registrar Ponto</button>
      <div id="erroNome" class="min-h-6 mt-2 text-sm font-semibold text-rose-600"></div>

      <div class="mt-3 rounded-xl bg-blue-50 border border-blue-100 p-3 text-xs text-blue-800">
        <p><strong>Privacidade:</strong> câmera e geolocalização são usadas somente neste registro.</p>
      </div>

      <div class="mt-3 text-sm text-slate-700" id="statusBox">Pronto para registrar.</div>
    </section>
  </main>

  <!-- MODAL (bottom sheet) -->
  <div id="modalFoto" class="fixed inset-0 hidden items-end justify-center z-50">
    <div class="absolute inset-0 bg-slate-900/60"></div>
    <div class="relative bg-white w-full max-w-xl rounded-t-2xl shadow-2xl overflow-hidden max-h-[100svh]">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <div>
          <h3 class="text-lg font-bold">Confirme seu registro</h3>
          <p class="text-[11px] text-slate-500">Autorize a câmera e centralize o rosto.</p>
        </div>
        <button id="fecharModal" class="p-2 rounded-lg hover:bg-slate-100" aria-label="Fechar">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="h-5 w-5"><path d="M6.225 4.811a.75.75 0 0 1 1.06 0L12 9.525l4.715-4.714a.75.75 0 1 1 1.06 1.06L13.06 10.586l4.715 4.715a.75.75 0 1 1-1.06 1.06L12 11.646l-4.715 4.715a.75.75 0 0 1-1.06-1.06l4.714-4.715-4.714-4.714a.75.75 0 0 1 0-1.061Z"/></svg>
        </button>
      </div>

      <div class="grid grid-cols-1 gap-0 max-h-[calc(100svh-4rem)] overflow-y-auto">
        <div class="p-4">
          <div class="relative rounded-xl overflow-hidden border bg-slate-100">
            <video id="video" playsinline autoplay class="w-full aspect-[3/4] object-cover bg-slate-200">Vídeo não disponível.</video>
            <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
              <div class="h-40 w-40 rounded-full border-4 border-white/70 shadow-[0_0_0_100vmax_rgba(0,0,0,0.25)]"></div>
            </div>
          </div>
          <canvas id="canvas" class="hidden"></canvas>

          <div class="mt-4 space-y-2 text-sm">
            <div><span class="font-medium">Funcionário:</span> <span id="previewNome">—</span></div>
            <div><span class="font-medium">Tipo:</span> <span id="previewTipo">—</span></div>
            <div><span class="font-medium">Localização:</span> <span id="previewLoc" class="text-slate-500">aguardando…</span></div>
          </div>

          <div class="mt-4 flex gap-3 sticky bottom-0 pt-3 bg-white">
            <button id="btnRetryCam" class="flex-1 px-4 py-3 rounded-xl border border-slate-300 hover:bg-slate-50 active:scale-[0.99]">Reiniciar câmera</button>
            <button id="confirmarRegistroBtn" class="flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold active:scale-[0.99]">Confirmar</button>
          </div>

          <div id="mensagem" class="mt-3 text-sm min-h-6"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 hidden bg-slate-900 text-white text-sm px-4 py-3 rounded-xl shadow-2xl"></div>

  <script>
    // ===== CONFIG =====
    const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbyHeYRDwUzulSPUQ3nwh2kp9b_euSbK2jJxb09IGCQcyGb-JbCTG7Q6Z72nDdbJP_j2TA/exec";

    // ===== UTILS =====
    const $ = (sel) => document.querySelector(sel);
    const clockEl = $('#clock');
    const statusBox = $('#statusBox');
    const toast = $('#toast');
    const showToast = (msg, ms=2400) => { toast.textContent = msg; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), ms); };
    const isHttpsOk = () => location.protocol === 'https:' || location.hostname === 'localhost';

    // Live clock
    (function startClock(){ const t=()=>clockEl.textContent=new Date().toLocaleTimeString('pt-BR'); t(); setInterval(t,1000) })();

    // Remember last name
    const nomeSelect = $('#nomeSelect');
    nomeSelect.value = localStorage.getItem('ponto:lastName') || '';
    nomeSelect.addEventListener('change', ()=> localStorage.setItem('ponto:lastName', nomeSelect.value));

    // HTTPS hint
    if(!isHttpsOk()){ const w = document.getElementById('httpsWarn'); w.textContent='Ative HTTPS para usar a câmera no celular'; w.classList.add('text-rose-600') }

    // Radio tipo
    const tipoSel = () => (document.querySelector('input[name="tipoRegistro"]:checked')||{}).value || '';

    // Modal refs
    const modal = $('#modalFoto');
    const abrirModalBtn = $('#abrirModalBtn');
    const fecharModalBtn = $('#fecharModal');
    const previewNome = $('#previewNome');
    const previewTipo = $('#previewTipo');
    const previewLoc  = $('#previewLoc');
    const erroNome = $('#erroNome');

    const video = $('#video');
    const canvas = $('#canvas');
    const btnRetryCam = $('#btnRetryCam');
    const confirmarRegistroBtn = $('#confirmarRegistroBtn');
    const mensagemDiv = $('#mensagem');

    let streamAtivo = null;
    let locCache = {lat:null,lng:null};

    function setStatus(msg){ if(statusBox) statusBox.textContent = msg }

    // Geolocalização com timeout seguro
    async function obterLocal(){
      previewLoc.textContent='obtendo…';
      if(!('geolocation' in navigator)){ previewLoc.textContent='Sem geolocalização'; return }
      const posP = new Promise((resolve,reject)=>navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:true,timeout:12000,maximumAge:0}));
      try{ const pos = await posP; locCache.lat=pos.coords.latitude; locCache.lng=pos.coords.longitude; previewLoc.textContent=`${locCache.lat.toFixed(6)}, ${locCache.lng.toFixed(6)}` }catch(e){ previewLoc.textContent = e.code===1? 'Permissão negada':'Falha ao obter localização' }
    }

    // Câmera com guards
    async function ligarCamera(){
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ setStatus('Câmera não suportada'); showToast('Dispositivo sem suporte a câmera'); throw new Error('no getUserMedia') }
      try{
        streamAtivo = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:720}, height:{ideal:960} }, audio:false });
        video.srcObject = streamAtivo;
        await video.play().catch(()=>{});
        setStatus('Câmera ligada.');
      }catch(e){ setStatus('Erro ao acessar câmera'); showToast('Não foi possível acessar a câmera'); throw e }
    }
    function desligarCamera(){ if(streamAtivo){ streamAtivo.getTracks().forEach(t=>t.stop()); streamAtivo=null } }

    function abrirModal(){
      const tipo = tipoSel();
      if(!nomeSelect.value || !tipo){ erroNome.textContent='Selecione nome e tipo.'; return }
      erroNome.textContent='';
      previewNome.textContent = nomeSelect.value;
      previewTipo.textContent = tipo;
      previewLoc.textContent  = 'aguardando…';
      modal.classList.remove('hidden');
      ligarCamera().catch(()=>{});
      obterLocal();
      mensagemDiv.textContent='';
      confirmarRegistroBtn.disabled=false; confirmarRegistroBtn.textContent='Confirmar';
    }

    function fecharModal(){ modal.classList.add('hidden'); desligarCamera() }

    async function capturarFoto(){
      const vw = video.videoWidth || 720, vh = video.videoHeight || 960;
      if(!canvas) throw new Error('Canvas não encontrado');
      canvas.width = vw; canvas.height = vh;
      const ctx = canvas.getContext('2d');
      if(!ctx) throw new Error('Canvas sem contexto');
      ctx.drawImage(video, 0, 0, vw, vh);
      return canvas.toDataURL('image/jpeg', 0.9);
    }

    async function enviar(){
      confirmarRegistroBtn.disabled=true; confirmarRegistroBtn.textContent='Registrando…';
      mensagemDiv.className='mt-3 text-sm text-slate-700'; mensagemDiv.textContent='Processando foto…';

      let fotoBase64='';
      try{ fotoBase64 = await capturarFoto() }catch(e){ mensagemDiv.className='mt-3 text-sm text-rose-600'; mensagemDiv.textContent='Falha ao capturar a foto'; confirmarRegistroBtn.disabled=false; confirmarRegistroBtn.textContent='Confirmar'; return }

      if(locCache.lat===null){ try{ await obterLocal() }catch(_){} }

      const payload = { nome: nomeSelect.value, tipo: tipoSel(), fotoBase64, latitude: locCache.lat ?? 'N/A', longitude: locCache.lng ?? 'N/A', obs: document.getElementById('obs').value || '' };

      mensagemDiv.textContent='Enviando…';
      try{
        const resp = await fetch(URL_APPS_SCRIPT, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
        const resultado = await resp.json().catch(()=>({status:'erro',mensagem:'Resposta inválida'}));
        if(resultado.status!=="sucesso") throw new Error(resultado.mensagem||'Erro no servidor');
        mensagemDiv.className='mt-3 text-sm text-emerald-600 font-semibold'; mensagemDiv.textContent='Ponto registrado com sucesso!';
        showToast('✅ Registro concluído');
        setTimeout(()=>{ fecharModal(); limpar(); }, 1200);
      }catch(e){ mensagemDiv.className='mt-3 text-sm text-rose-600 font-semibold'; mensagemDiv.textContent=`Erro: ${e.message||e}`; confirmarRegistroBtn.disabled=false; confirmarRegistroBtn.textContent='Tentar novamente' }
    }

    function limpar(){ nomeSelect.value=''; (document.querySelector('input[name="tipoRegistro"]:checked')||{}).checked=false; document.getElementById('obs').value=''; setStatus('Pronto para registrar.') }

    // Eventos
    abrirModalBtn.addEventListener('click', abrirModal);
    fecharModalBtn.addEventListener('click', fecharModal);
    document.getElementById('modalFoto').addEventListener('click', (e)=>{ if(e.target.id==='modalFoto') fecharModal() });
    btnRetryCam.addEventListener('click', ()=>{ desligarCamera(); ligarCamera().catch(()=>{}) });
    confirmarRegistroBtn.addEventListener('click', enviar);
  </script>
</body>
</html>
